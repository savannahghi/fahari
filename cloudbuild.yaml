steps:
  # build the container image
  - name: "gcr.io/cloud-builders/docker"
    args:
      [
        "build",
        "-t",
        "europe-west1-docker.pkg.dev/$PROJECT_ID/sghi/mle:$COMMIT_SHA",
        ".",
      ]

  # Push the container image to Container Registry
  - name: "gcr.io/cloud-builders/docker"
    args:
      ["push", "europe-west1-docker.pkg.dev/$PROJECT_ID/sghi/mle:$COMMIT_SHA"]

  # Deploy an image from Container Registry to Cloud Run
  - name: 'gcr.io/cloud-builders/gcloud'
    args: [
      'run',
      'deploy',
      'mle',
      '--image', 'europe-west1-docker.pkg.dev/$PROJECT_ID/sghi/mle:$COMMIT_SHA',
      '--region', 'europe-west1',
      '--platform', 'managed',
      '--allow-unauthenticated',
      '--add-cloudsql-instances', '${_CLOUDSQL_INSTANCE_CONNECTION_NAME}',
      '--update-env-vars', 'SENTRY_ENVIRONMENT=prod,COMPRESS_ENABLED=true,DJANGO_DEBUG=false,USE_DOCKER=yes,DJANGO_READ_DOT_ENV_FILE=False,DJANGO_SETTINGS_MODULE=config.settings.production,DJANGO_SECURE_SSL_REDIRECT=False,WEB_CONCURRENCY=4,DJANGO_EMAIL_SUBJECT_PREFIX=[mle],DJANGO_SESSION_COOKIE_SECURE=True,DJANGO_SESSION_COOKIE_HTTPONLY=True,DJANGO_SECURE_HSTS_INCLUDE_SUBDOMAINS=True,DJANGO_SECURE_SSL_REDIRECT=True,DJANGO_SECURE_BROWSER_XSS_FILTER=True,DJANGO_SECURE_CONTENT_TYPE_NOSNIFF=True,DJANGO_SECURE_FRAME_DENY=True,DJANGO_ACCOUNT_ALLOW_REGISTRATION=${_DJANGO_ACCOUNT_ALLOW_REGISTRATION},DJANGO_GCP_STORAGE_BUCKET_NAME=${_DJANGO_GCP_STORAGE_BUCKET_NAME},SENTRY_DSN=${_SENTRY_DSN},DJANGO_SECRET_KEY=${_DJANGO_SECRET_KEY},DJANGO_ADMIN_URL=${_DJANGO_ADMIN_URL},MAILGUN_API_KEY=${_MAILGUN_API_KEY},MAILGUN_DOMAIN=${_MAILGUN_DOMAIN},MAILGUN_API_URL=${_MAILGUN_API_URL},DJANGO_SERVER_EMAIL=${_DJANGO_SERVER_EMAIL},DJANGO_DEFAULT_FROM_EMAIL=${_DJANGO_DEFAULT_FROM_EMAIL},INSTANCE_CONNECTION_NAME=${_CLOUDSQL_INSTANCE_CONNECTION_NAME}:${COMMIT_SHA},POSTGRES_HOST=${_POSTGRES_HOST},POSTGRES_PORT=${_POSTGRES_PORT},POSTGRES_DB=${_POSTGRES_DB},POSTGRES_USER=${_POSTGRES_USER},POSTGRES_PASSWORD=${_POSTGRES_PASSWORD},CLOUD_SQL_PROXY_VERSION=${_CLOUD_SQL_PROXY_VERSION}'
  ]

images:
  - "europe-west1-docker.pkg.dev/$PROJECT_ID/sghi/mle:$COMMIT_SHA"
